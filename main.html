<!DOCTYPE html>
<html>
<head>
    <title></title>
</head>
<body>

<canvas id="canvas" width="300" height="500"></canvas>

<script>

var Breakout = (function () {
    var a = document.getElementById("canvas");
    var canvas = a.getContext("2d");
    var canvas_width = a.getAttribute("width");
    var canvas_height = a.getAttribute("height");
    var colors = ["deeppink", "dodgerblue", "greenyellow", "gold", "orangered", "seegreen", "slategray", "purple", "peru", "lightcoral"];
    var blocklist = [];
    var ball;
    var start_x = (canvas_width * 1 + 70) / 2 - 70;
    var start_y = canvas_height - 10;


    var board = {
        width: 70,
        height: 10,
        x: start_x,
        y: start_y,
        moving: 0,
        speed: 4,
        draw: function () {
            canvas.fillStyle = "white";
            canvas.strokeStyle = "black";
            canvas.fillRect(this.x, this.y, this.width, this.height);
            canvas.strokeRect(this.x, this.y, this.width, this.height);
        },
        setX: function (x) {
            if (x < 0) this.x = 0;
            else if (x + this.width > canvas_width) this.x = canvas_width - this.width;
            else this.x = x;
        }
    };

    var moduleBlock = (function () {
        var _height = 10;
        var _width = 30;
        var Block = function (x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.width = _width;
            this.height = _height;
            this.display = true;
        };

        Block.prototype.draw = function () {
            canvas.fillStyle = this.color;
            canvas.strokeStyle = "black";
            canvas.fillRect(this.x, this.y, this.width, this.height);
            canvas.strokeRect(this.x, this.y, this.width, this.height);
        };

        var setWidth = function (w) {
            _width = w;
        };

        var setHeight = function (h) {
            _height = h;
        };

        var getWidth = function () {
            return _width;
        };

        var getHeight = function () {
            return _height;
        };

        return {
            Block: Block,
            setWidth: setWidth,
            setHeight: setHeight,
            getWidth: getWidth,
            getHeight: getHeight
        }

    })();

    var moduleBall = (function () {
        var _radius = 5;
        var Ball = function (x, y) {
            this.x = x;
            this.y = y;
            this.width = this.height = 2 * _radius;
            this.speed = 5;
            this.angle = 45;
        };

        Ball.prototype.draw = function () {
            canvas.fillStyle = "red";
            canvas.beginPath();
            canvas.arc(this.x + _radius, this.y + _radius, _radius, 0, 2 * Math.PI);
            canvas.fill();
        };

        Ball.prototype.setX = function (x) {
            if (x < 0) {
                this.vel_x = -this.vel_x;
                this.pos_x = x;
            }
            else if (x + _radius > canvas_width) {
                this.vel_x = -this.vel_x;
                this.pos_x = x;
            }
            else {
                this.pos_x = x;
            }
        };

        Ball.prototype.setY = function (y) {
            if (y < 0) {
                this.vel_y = -this.vel_y;
                this.pos_y = y;
            }
            else if (y + _radius - 5 > canvas_height) {

                alert("You lose!")
            }
            else {
                this.pos_y = y;
            }
        };

        var setRadius = function (r) {
            _radius = r;
        };

        var getRadius = function () {
            return _radius;
        };

        return {
            Ball: Ball,
            setRadius: setRadius,
            getRadius: getRadius
        }
    })();

    var init = function () {
        //blocks
        var z = 0;
        for (var i = 0; i < canvas_width; i += moduleBlock.getWidth()) {
            for (var j = 0; j < canvas_height / 2; j += moduleBlock.getHeight()) {
                blocklist[z] = new moduleBlock.Block(i, j, colors[getRandomInt(0, 10)]);
                z++;
            }
        }
        //ball
        ball = new moduleBall.Ball(canvas_width / 2 - moduleBall.getRadius(), canvas_height - board.height - 2 * moduleBall.getRadius());
    };

    var drawAll = function () {
        //background
        canvas.fillStyle = "lavender";
        canvas.fillRect(0, 0, canvas_width, canvas_height);
        //blocks
        for (var z = 0; z < blocklist.length; z++) {
            if (blocklist[z].display == true) {
                blocklist[z].draw();
            }
        }
        //board
        board.draw();
        //ball
        ball.draw();
    };

    var getRandomInt = function (min, max) {
        return Math.floor(Math.random() * (max - min) + min);
    };

    var toRadians = function (angle) {
        return angle * (Math.PI / 180);
    };

    var detectCollision = function (obj1, obj2) {
        if (obj1.x < obj2.x + obj2.width &&
                obj1.x + obj1.width > obj2.x &&
                obj1.y < obj2.y + obj2.height &&
                obj1.height + obj1.y > obj2.y) {
            return true;
        }
        else return false;
    };

    var update = function () {
        // update the position of the ball
        var move_x = ball.speed * Math.cos(toRadians(ball.angle));
        var move_y = ball.speed * Math.sin(toRadians(ball.angle));
        ball.x += move_x;
        ball.y -= move_y;

        //make sure the ball stays inside canvas
        if (ball.x < 0 || ball.x + moduleBall.getRadius() > canvas_width) {
            ball.angle = 180 - ball.angle;
        }
        else if (ball.y + moduleBall.getRadius() < 0) {
            ball.angle = 360 - ball.angle;
        }
        else if (ball.y + moduleBall.getRadius() > canvas_height) {
            alert("you lose")
        }

        // update the position of the board
        //listen for user input
        var onkey = function (ev) {
            var key = ev.keyCode;
            if (key == 37) { //left
                board.moving = 1;
            }
            else if (key == 39) { //right
                board.moving = 2;
            }
        };
        document.addEventListener('keydown', function (ev) {
            return onkey(ev);
        });
        document.addEventListener('keyup', function () {
            board.moving = 0;
        });
        switch (board.moving) {
            case 1:
                board.setX(board.x - board.speed);
                break;
            case 2:
                board.setX(board.x + board.speed);
                break;
        }

        // check for collision between ball and blocks
        // update ball velocity
        // make the block disappear
        for (var i = 0; i < blocklist.length; i++) {
            if (blocklist[i].display) {
                if (detectCollision(blocklist[i], ball)) {
                    blocklist[i].display = false;
                    ball.angle = 360 - ball.angle;
                }
            }
        }

        // check for collision between ball and board
        // update the ball velocity based on where it hit the board
        var extra_angle = 30;
        if (detectCollision(ball, board)) {
            var dx = ball.x - board.x;
            var formula = (2 * extra_angle * dx) / board.width;

            ball.angle = (360 - ball.angle) - (formula - extra_angle);

        }


        drawAll();
    };

    var gameLoop = function () {
        update();
        requestAnimationFrame(gameLoop);
    };

    return{
        init: init,
        moduleBall: moduleBall,
        moduleBlock: moduleBlock,
        gameLoop: gameLoop
    }

})();

Breakout.init();
Breakout.gameLoop();


</script>

</body>
</html>